// Language Translations
const translations = {
  en: {
    'header.title': 'Combined Private University Forum',
    'nav.home': 'Home',
    'nav.news': 'News',
    'nav.events': 'Events',
    'nav.register': 'Register',
    'nav.library': 'Library',
    'nav.poll': 'Poll',
    'nav.donate': 'Donate',
    'donate.title': 'Support Our Cause',
    'donate.payment': 'Payment Methods',
    'donate.bkash': 'bKash: +880 123 456 7890',
    'donate.nagad': 'Nagad: +880 123 456 7890',
    'donate.bank': 'Bank Account: CPUF, Account No: 123456789, Bank Name',
    'donate.regular': 'Regular Donation',
    'donate.anonymous': 'Anonymous Donation',
    'donate.phone': 'Phone Number',
    'donate.transaction': 'Transaction ID',
    'donate.submit': 'Submit Donation',
    'donate.close': 'Close',
    'donate.success': 'Donation submitted successfully!',
    'donate.error': 'Error submitting donation. Please try again.',
    'hero.title': 'Join Our Movement',
    'hero.description': 'Together, we can build a stronger, more inclusive future for our nation. Join CPUF to make a difference.',
    'hero.join': 'Become a Member',
    'news.title': 'Latest News',
    'news.empty': 'No news available.',
    'register.title': 'Member Registration',
    'register.name': 'Full Name',
    'register.email': 'Email',
    'register.phone': 'Phone',
    'register.id': 'Student ID/National ID',
    'register.university': 'University Name (if applicable)',
    'register.submit': 'Register',
    'register.success': 'Registration successful!',
    'register.error': 'Error registering. Please try again.',
    'library.title': 'Study Resources',
    'library.download': 'Download PDF',
    'library.empty': 'No resources available.',
    'poll.title': 'Voting Poll',
    'poll.submit': 'Vote',
    'poll.select': 'Please select a candidate.',
    'poll.success': 'Vote recorded successfully!',
    'poll.error': 'Error recording vote. Please try again.',
    'poll.empty': 'No polls available.',
    'events.title': 'Events',
    'events.running': 'Running Events',
    'events.upcoming': 'Upcoming Events',
    'events.past': 'Past Events',
    'events.empty': 'No events available.',
    'join.title': 'Join Event',
    'join.name': 'Full Name',
    'join.email': 'Email',
    'join.phone': 'Phone',
    'join.submit': 'Join Event',
    'join.close': 'Close',
    'join.success': 'Successfully joined the event!',
    'join.error': 'Error joining the event. Please try again.',
    'footer.copyright': '© 2025 CPUF. All rights reserved.',
    'footer.contact': 'Contact us: info@cpuf.org | +880 123 456 7890',
    'general.error': 'An error occurred. Please try again.',
  },
  bn: {
    'header.title': 'সিপিইউএফ',
    'nav.home': 'হোম',
    'nav.news': 'সংবাদ',
    'nav.events': 'ইভেন্ট',
    'nav.register': 'নিবন্ধন',
    'nav.library': 'লাইব্রেরি',
    'nav.poll': 'ভোট',
    'nav.donate': 'দান করুন',
    'donate.title': 'আমাদের কারণ সমর্থন করুন',
    'donate.payment': 'পেমেন্ট পদ্ধতি',
    'donate.bkash': 'বিকাশ: +৮৮০ ১২৩ ৪৫৬ ৭৮৯০',
    'donate.nagad': 'নগদ: +৮৮০ ১২৩ ৪৫৬ ৭৮৯০',
    'donate.bank': 'ব্যাংক অ্যাকাউন্ট: সিপিইউএফ, অ্যাকাউন্ট নং: ১২৩৪৫৬৭৮৯, ব্যাংকের নাম',
    'donate.regular': 'নিয়মিত দান',
    'donate.anonymous': 'বেনামী দান',
    'donate.phone': 'ফোন নম্বর',
    'donate.transaction': 'ট্রানজাকশন আইডি',
    'donate.submit': 'দান জমা দিন',
    'donate.close': 'বন্ধ করুন',
    'donate.success': 'দান সফলভাবে জমা দেওয়া হয়েছে!',
    'donate.error': 'দান জমা দেওয়ার সময় ত্রুটি হয়েছে। আবার চেষ্টা করুন।',
    'hero.title': 'আমাদের আন্দোলনে যোগ দিন',
    'hero.description': 'একসাথে, আমরা আমাদের জাতির জন্য একটি শক্তিশালী এবং আরও অন্তর্ভুক্তিমূলক ভবিষ্যৎ গড়ে তুলতে পারি। সিপিইউএফ-এ যোগ দিয়ে পার্থক্য তৈরি করুন।',
    'hero.join': 'সদস্য হন',
    'news.title': 'সর্বশেষ সংবাদ',
    'news.empty': 'কোনো সংবাদ নেই।',
    'register.title': 'সদস্য নিবন্ধন',
    'register.name': 'পূর্ণ নাম',
    'register.email': 'ইমেইল',
    'register.phone': 'ফোন',
    'register.id': 'ছাত্র আইডি/জাতীয় আইডি',
    'register.university': 'বিশ্ববিদ্যালয়ের নাম (যদি প্রযোজ্য হয়)',
    'register.submit': 'নিবন্ধন করুন',
    'register.success': 'নিবন্ধন সফল!',
    'register.error': 'নিবন্ধনের সময় ত্রুটি হয়েছে। আবার চেষ্টা করুন।',
    'library.title': 'অধ্যয়ন সম্পদ',
    'library.download': 'পিডিএফ ডাউনলোড করুন',
    'library.empty': 'কোনো সম্পদ নেই।',
    'poll.title': 'ভোটিং পোল',
    'poll.submit': 'ভোট দিন',
    'poll.select': 'অনুগ্রহ করে একজন প্রার্থী নির্বাচন করুন।',
    'poll.success': 'ভোট সফলভাবে রেকর্ড করা হয়েছে!',
    'poll.error': 'ভোট রেকর্ড করার সময় ত্রুটি হয়েছে। আবার চেষ্টা করুন।',
    'poll.empty': 'কোনো পোল নেই।',
    'events.title': 'ইভেন্ট',
    'events.running': 'চলমান ইভেন্ট',
    'events.upcoming': 'আসন্ন ইভেন্ট',
    'events.past': 'অতীত ইভেন্ট',
    'events.empty': 'কোনো ইভেন্ট নেই।',
    'join.title': 'ইভেন্টে যোগ দিন',
    'join.name': 'পূর্ণ নাম',
    'join.email': 'ইমেইল',
    'join.phone': 'ফোন',
    'join.submit': 'ইভেন্টে যোগ দিন',
    'join.close': 'বন্ধ করুন',
    'join.success': 'ইভেন্টে সফলভাবে যোগ দেওয়া হয়েছে!',
    'join.error': 'ইভেন্টে যোগ দেওয়ার সময় ত্রুটি হয়েছে। আবার চেষ্টা করুন।',
    'footer.copyright': '© ২০২৫ সিপিইউএফ। সর্বস্বত্ব সংরক্ষিত।',
    'footer.contact': 'যোগাযোগ করুন: info@cpuf.org | +৮৮০ ১২৩ ৪৫৬ ৭৮৯০',
    'general.error': 'একটি ত্রুটি হয়েছে। আবার চেষ্টা করুন।',
  },
  ar: {
    'header.title': 'سي بي يو إف',
    'nav.home': 'الرئيسية',
    'nav.news': 'الأخبار',
    'nav.events': 'الفعاليات',
    'nav.register': 'التسجيل',
    'nav.library': 'المكتبة',
    'nav.poll': 'التصويت',
    'nav.donate': 'التبرع',
    'donate.title': 'ادعم قضيتنا',
    'donate.payment': 'طرق الدفع',
    'donate.bkash': 'بيكاش: +880 123 456 7890',
    'donate.nagad': 'ناجاد: +880 123 456 7890',
    'donate.bank': 'الحساب البنكي: سي بي يو إف، رقم الحساب: 123456789، اسم البنك',
    'donate.regular': 'التبرع العادي',
    'donate.anonymous': 'التبرع المجهول',
    'donate.phone': 'رقم الهاتف',
    'donate.transaction': 'معرف المعاملة',
    'donate.submit': 'إرسال التبرع',
    'donate.close': 'إغلاق',
    'donate.success': 'تم إرسال التبرع بنجاح!',
    'donate.error': 'خطأ في إرسال التبرع. حاول مرة أخرى.',
    'hero.title': 'انضم إلى حركتنا',
    'hero.description': 'معًا، يمكننا بناء مستقبل أقوى وأكثر شمولًا لأمتنا. انضم إلى سي بي يو إف لإحداث فرق.',
    'hero.join': 'كن عضوًا',
    'news.title': 'آخر الأخبار',
    'news.empty': 'لا توجد أخبار متاحة.',
    'register.title': 'تسجيل العضوية',
    'register.name': 'الاسم الكامل',
    'register.email': 'البريد الإلكتروني',
    'register.phone': 'الهاتف',
    'register.id': 'رقم الطالب/رقم الهوية الوطنية',
    'register.university': 'اسم الجامعة (إن وجد)',
    'register.submit': 'تسجيل',
    'register.success': 'تم التسجيل بنجاح!',
    'register.error': 'خطأ في التسجيل. حاول مرة أخرى.',
    'library.title': 'موارد الدراسة',
    'library.download': 'تحميل PDF',
    'library.empty': 'لا توجد موارد متاحة.',
    'poll.title': 'استطلاع الرأي',
    'poll.submit': 'تصويت',
    'poll.select': 'يرجى اختيار مرشح.',
    'poll.success': 'تم تسجيل التصويت بنجاح!',
    'poll.error': 'خطأ في تسجيل التصويت. حاول مرة أخرى.',
    'poll.empty': 'لا توجد استطلاعات متاحة.',
    'events.title': 'الفعاليات',
    'events.running': 'الفعاليات الجارية',
    'events.upcoming': 'الفعاليات القادمة',
    'events.past': 'الفعاليات السابقة',
    'events.empty': 'لا توجد فعاليات متاحة.',
    'join.title': 'الانضمام إلى الفعالية',
    'join.name': 'الاسم الكامل',
    'join.email': 'البريد الإلكتروني',
    'join.phone': 'الهاتف',
    'join.submit': 'الانضمام إلى الفعالية',
    'join.close': 'إغلاق',
    'join.success': 'تم الانضمام إلى الفعالية بنجاح!',
    'join.error': 'خطأ في الانضمام إلى الفعالية. حاول مرة أخرى.',
    'footer.copyright': '© 2025 سي بي يو إف. جميع الحقوق محفوظة.',
    'footer.contact': 'اتصل بنا: info@cpuf.org | +880 123 456 7890',
    'general.error': 'حدث خطأ. حاول مرة أخرى.',
  },
};

// Utility to show notifications
function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  const notificationMessage = document.getElementById('notification-message');
  notificationMessage.textContent = message;
  notification.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
  notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
  setTimeout(() => notification.classList.add('hidden'), 5000);
}

document.getElementById('close-notification').addEventListener('click', () => {
  document.getElementById('notification').classList.add('hidden');
});

// Mobile Menu Toggle
document.getElementById('mobile-menu-btn').addEventListener('click', () => {
  const mobileMenu = document.getElementById('mobile-menu');
  mobileMenu.classList.toggle('hidden');
});

// Sync mobile and desktop language switches
function syncLanguageSelects(value) {
  document.getElementById('language-switch').value = value;
  document.getElementById('language-switch-mobile').value = value;
  updateLanguage(value);
}

document.getElementById('language-switch').addEventListener('change', (e) => {
  syncLanguageSelects(e.target.value);
});

document.getElementById('language-switch-mobile').addEventListener('change', (e) => {
  syncLanguageSelects(e.target.value);
});

document.getElementById('donate-btn-mobile').addEventListener('click', () => {
  document.getElementById('donate-modal').classList.remove('hidden');
  document.getElementById('mobile-menu').classList.add('hidden');
  document.getElementById('donor-phone').focus();
});

// Language Switcher
function updateLanguage(lang) {
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (translations[lang][key]) {
      element.textContent = translations[lang][key];
    }
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (translations[lang][key]) {
      element.placeholder = translations[lang][key];
    }
  });
  document.documentElement.lang = lang;
  if (lang === 'ar') {
    document.body.style.direction = 'rtl';
    document.querySelectorAll('.text-left').forEach(el => el.classList.replace('text-left', 'text-right'));
  } else {
    document.body.style.direction = 'ltr';
    document.querySelectorAll('.text-right').forEach(el => el.classList.replace('text-right', 'text-left'));
  }
  localStorage.setItem('language', lang);
  loadDynamicContent(lang);
}

// Load Dynamic Content
async function loadDynamicContent(lang) {
  try {
    // Fetch Logo
    const settingsRes = await fetch('/api/settings');
    if (!settingsRes.ok) throw new Error('Failed to fetch settings');
    const settings = await settingsRes.json();
    const logo = document.getElementById('party-logo');
    if (settings.logo) {
      logo.src = settings.logo;
      logo.classList.remove('hidden');
    } else {
      logo.classList.add('hidden');
    }

    // Fetch News
    const newsRes = await fetch('/api/news');
    if (!newsRes.ok) throw new Error('Failed to fetch news');
    const news = await newsRes.json();
    const newsList = document.getElementById('news-list');
    newsList.innerHTML = news.length ? '' : `<p class="text-center" data-i18n="news.empty">${translations[lang]['news.empty']}</p>`;
    news.forEach(item => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${item.title}</h3>
        <p class="text-gray-600 mb-2">${item.date}</p>
        <p class="text-gray-700 mb-4">${item.description}</p>
        ${item.image ? `<img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover rounded mb-4">` : ''}
      `;
      newsList.appendChild(div);
    });

    // Fetch Events
    const eventsRes = await fetch('/api/events');
    if (!eventsRes.ok) throw new Error('Failed to fetch events');
    const events = await eventsRes.json();

    const runningEventList = document.getElementById('running-event-list');
    runningEventList.innerHTML = events.running.length ? '' : `<p class="text-center" data-i18n="events.empty">${translations[lang]['events.empty']}</p>`;
    events.running.forEach(event => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${event.title}</h3>
        <p class="text-gray-600 mb-2">${event.date}</p>
        <p class="text-gray-700 mb-4">${event.description}</p>
        ${event.image ? `<img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover rounded mb-4">` : ''}
        <button onclick="openJoinModal('${event.id}')" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition w-full md:w-auto" data-i18n="join.submit">${translations[lang]['join.submit']}</button>
      `;
      runningEventList.appendChild(div);
    });

    const upcomingEventList = document.getElementById('upcoming-event-list');
    upcomingEventList.innerHTML = events.upcoming.length ? '' : `<p class="text-center" data-i18n="events.empty">${translations[lang]['events.empty']}</p>`;
    events.upcoming.forEach(event => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${event.title}</h3>
        <p class="text-gray-600 mb-2">${event.date}</p>
        <p class="text-gray-700 mb-4">${event.description}</p>
        ${event.image ? `<img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover rounded mb-4">` : ''}
        <button onclick="openJoinModal('${event.id}')" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition w-full md:w-auto" data-i18n="join.submit">${translations[lang]['join.submit']}</button>
      `;
      upcomingEventList.appendChild(div);
    });

    const pastEventList = document.getElementById('past-event-list');
    pastEventList.innerHTML = events.past.length ? '' : `<p class="text-center" data-i18n="events.empty">${translations[lang]['events.empty']}</p>`;
    events.past.forEach(event => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${event.title}</h3>
        <p class="text-gray-600 mb-2">${event.date}</p>
        <p class="text-gray-700 mb-4">${event.description}</p>
        ${event.image ? `<img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover rounded mb-4">` : ''}
      `;
      pastEventList.appendChild(div);
    });

    // Fetch Resources
    const resourceRes = await fetch('/api/resources');
    if (!resourceRes.ok) throw new Error('Failed to fetch resources');
    const resources = await resourceRes.json();
    const resourceList = document.getElementById('resource-list');
    resourceList.innerHTML = resources.length ? '' : `<p class="text-center" data-i18n="library.empty">${translations[lang]['library.empty']}</p>`;
    resources.forEach(resource => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${resource.title}</h3>
        <p class="text-gray-700 mb-4">${resource.description}</p>
        ${resource.pdf ? `<a href="${resource.pdf}" class="text-blue-500 underline" target="_blank" data-i18n="library.download">${translations[lang]['library.download']}</a>` : ''}
      `;
      resourceList.appendChild(div);
    });

    // Fetch Polls
    const pollRes = await fetch('/api/polls');
    if (!pollRes.ok) throw new Error('Failed to fetch polls');
    const polls = await pollRes.json();
    const pollList = document.getElementById('poll-list');
    pollList.innerHTML = polls.length ? '' : `<p class="text-center" data-i18n="poll.empty">${translations[lang]['poll.empty']}</p>`;
    polls.forEach(poll => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md mb-4';
      div.innerHTML = `
        <h3 class="text-lg md:text-xl font-semibold mb-2">${poll.question}</h3>
        <form class="vote-form" data-poll-id="${poll.id}">
          ${poll.options.map(option => `
            <div class="mb-2">
              <input type="radio" name="candidate" value="${option}" id="${poll.id}-${option}" class="mr-2">
              <label for="${poll.id}-${option}">${option}</label>
            </div>
          `).join('')}
          <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition w-full md:w-auto" data-i18n="poll.submit">${translations[lang]['poll.submit']}</button>
        </form>
        <div id="poll-results-${poll.id}" class="mt-4 hidden">
          ${Object.entries(poll.votes).map(([option, count]) => `
            <p>${option}: ${count} votes</p>
          `).join('')}
        </div>
      `;
      pollList.appendChild(div);
    });

    // Attach vote form listeners
    document.querySelectorAll('.vote-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const pollId = form.getAttribute('data-poll-id');
        const candidate = form.querySelector('input[name="candidate"]:checked');
        if (!candidate) {
          showNotification(translations[lang]['poll.select'], true);
          return;
        }
        try {
          const res = await fetch(`/api/polls/${pollId}/vote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ candidate: candidate.value }),
          });
          if (!res.ok) throw new Error('Failed to vote');
          const data = await res.json();
          showNotification(translations[lang]['poll.success']);
          const resultsDiv = document.getElementById(`poll-results-${pollId}`);
          resultsDiv.innerHTML = Object.entries(data.votes).map(([option, count]) => `
            <p>${option}: ${count} votes</p>
          `).join('');
          resultsDiv.classList.remove('hidden');
          form.reset();
        } catch (error) {
          console.error('Vote submission error:', error.message);
          showNotification(translations[lang]['poll.error'], true);
        }
      });
    });
  } catch (error) {
    console.error('Content loading error:', error.message);
    showNotification(translations[lang]['general.error'], true);
  }
}

// Modal Handlers
function openJoinModal(eventId) {
  document.getElementById('join-event-id').value = eventId;
  document.getElementById('join-event-modal').classList.remove('hidden');
  document.getElementById('mobile-menu').classList.add('hidden');
  document.getElementById('join-name').focus();
}

document.getElementById('close-join-modal').addEventListener('click', () => {
  document.getElementById('join-event-modal').classList.add('hidden');
  document.getElementById('join-event-form').reset();
});

document.getElementById('donate-btn').addEventListener('click', () => {
  document.getElementById('donate-modal').classList.remove('hidden');
  document.getElementById('donor-phone').focus();
});

document.getElementById('close-donate-modal').addEventListener('click', () => {
  document.getElementById('donate-modal').classList.add('hidden');
  document.getElementById('donate-form').reset();
  document.getElementById('anonymous-donate-form').reset();
});

// Form Submissions
document.getElementById('donate-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const phone = document.getElementById('donor-phone').value;
  const transactionId = document.getElementById('donor-transaction-id').value;
  const lang = document.getElementById('language-switch').value;
  try {
    const res = await fetch('/api/donations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, transactionId }),
    });
    if (!res.ok) throw new Error('Failed to submit donation');
    const formspreeRes = await fetch(e.target.action, {
      method: 'POST',
      body: new FormData(e.target),
      headers: { 'Accept': 'application/json' },
    });
    if (!formspreeRes.ok) throw new Error('Failed to submit to Formspree');
    showNotification(translations[lang]['donate.success']);
    e.target.reset();
    document.getElementById('donate-modal').classList.add('hidden');
  } catch (error) {
    console.error('Donation submission error:', error.message);
    showNotification(translations[lang]['donate.error'], true);
  }
});

document.getElementById('anonymous-donate-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const transactionId = document.getElementById('anonymous-transaction-id').value;
  const lang = document.getElementById('language-switch').value;
  try {
    const res = await fetch('/api/donations', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ transactionId }),
    });
    if (!res.ok) throw new Error('Failed to submit donation');
    const formspreeRes = await fetch(e.target.action, {
      method: 'POST',
      body: new FormData(e.target),
      headers: { 'Accept': 'application/json' },
    });
    if (!formspreeRes.ok) throw new Error('Failed to submit to Formspree');
    showNotification(translations[lang]['donate.success']);
    e.target.reset();
    document.getElementById('donate-modal').classList.add('hidden');
  } catch (error) {
    console.error('Anonymous donation submission error:', error.message);
    showNotification(translations[lang]['donate.error'], true);
  }
});

document.getElementById('registration-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const idNumber = document.getElementById('id-number').value;
  const university = document.getElementById('university').value;
  const lang = document.getElementById('language-switch').value;
  try {
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone, idNumber, university }),
    });
    if (!res.ok) throw new Error('Failed to register');
    const formspreeRes = await fetch(e.target.action, {
      method: 'POST',
      body: new FormData(e.target),
      headers: { 'Accept': 'application/json' },
    });
    if (!formspreeRes.ok) throw new Error('Failed to submit to Formspree');
    showNotification(translations[lang]['register.success']);
    e.target.reset();
  } catch (error) {
    console.error('Registration error:', error.message);
    showNotification(translations[lang]['register.error'], true);
  }
});

document.getElementById('join-event-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const eventId = document.getElementById('join-event-id').value;
  const name = document.getElementById('join-name').value;
  const email = document.getElementById('join-email').value;
  const phone = document.getElementById('join-phone').value;
  const lang = document.getElementById('language-switch').value;
  try {
    const res = await fetch('/api/join-event', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ eventId, name, email, phone }),
    });
    if (!res.ok) throw new Error('Failed to join event');
    const formspreeRes = await fetch(e.target.action, {
      method: 'POST',
      body: new FormData(e.target),
      headers: { 'Accept': 'application/json' },
    });
    if (!formspreeRes.ok) throw new Error('Failed to submit to Formspree');
    showNotification(translations[lang]['join.success']);
    e.target.reset();
    document.getElementById('join-event-modal').classList.add('hidden');
  } catch (error) {
    console.error('Join event submission error:', error.message);
    showNotification(translations[lang]['join.error'], true);
  }
});

// Initialize Language
const savedLang = localStorage.getItem('language') || 'en';
syncLanguageSelects(savedLang);